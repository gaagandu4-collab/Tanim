<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanim AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anek+Bangla:wght@400;500;600;700&family=Orbitron:wght@400;700&family=Michroma&display=swap" rel="stylesheet">
    
    <!-- MathJax Configuration -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          }
        };
    </script>
    <script id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>

    <style>
        :root {
            --bg-main: #1F1301;
            --glass-bg-rgba: 90, 57, 8, 0.6;
            --accent-color: #FFA800;
            --accent-dark: #9D5A0B;
            --accent-rgb: 255, 168, 0;
            --text-main: #f0f0f0;
            --text-dark: #1F1301;
        }
        html, body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Anek Bangla', sans-serif; color: var(--text-main); }
        #glcanvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; display: block; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        .glass-ui { background: rgba(var(--glass-bg-rgba), 0.5); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border: 1px solid rgba(var(--accent-rgb), 0.2); }
        .glass-btn { background: rgba(var(--accent-rgb), 0.1); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(var(--accent-rgb), 0.3); transition: all 0.3s ease; color: var(--accent-color); }
        .glass-btn:hover { background: rgba(var(--accent-rgb), 0.2); border-color: rgba(var(--accent-rgb), 0.6); box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.25); }
        #chat-container::-webkit-scrollbar { width: 6px; }
        #chat-container::-webkit-scrollbar-track { background: transparent; }
        #chat-container::-webkit-scrollbar-thumb { background: rgba(var(--accent-rgb), 0.4); border-radius: 3px; }
        #logo-container { display: flex; align-items: center; gap: 0.75rem; }
        #text-overlay { position: relative; font-family: 'Michroma', sans-serif; font-weight: normal; font-size: 1.75rem; pointer-events: none; background: linear-gradient(90deg, #ff00ae, #ff7300, #4d00ff, #00c8ff, #ff00ae); background-size: 400% 100%; animation: mix-colors 8s linear infinite; -webkit-background-clip: text; background-clip: text; color: transparent; }
        @keyframes mix-colors { 0% { background-position: 0% 50%; } 100% { background-position: 400% 50%; } }
        .loader-spinner { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--accent-color); border-color: var(--accent-color) transparent var(--accent-color) transparent; animation: spin 1.2s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .message-bubble { overflow-wrap: break-word; word-wrap: break-word; word-break: break-word; white-space: pre-wrap; }
        .message-bubble.user { background-color: #5A3908; }
        .message-bubble.ai { background-color: #3a2505; }
        .tts-btn { cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .tts-btn:hover { opacity: 1; }
        .tts-btn.playing .speaker-icon-on { display: inline-block; }
        .tts-btn.playing .speaker-icon-off { display: none; }
        .tts-btn .speaker-icon-on { display: none; }
        #mic-btn.listening { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0.7); } 70% { box-shadow: 0 0 0 10px rgba(var(--accent-rgb), 0); } 100% { box-shadow: 0 0 0 0 rgba(var(--accent-rgb), 0); } }
        #search-toggle-btn.search-active { background: rgba(var(--accent-rgb), 0.25); border-color: rgba(var(--accent-rgb), 0.8); box-shadow: 0 0 18px rgba(var(--accent-rgb), 0.45); color: white; }
        #dont-show-again { accent-color: var(--accent-color); }
    </style>
</head>
<body class="overflow-hidden">

    <canvas id="glcanvas"></canvas>

    <div id="app-container" class="w-screen flex flex-col absolute top-0 left-0">
        <header class="glass-ui px-4 py-2 flex justify-between items-center z-10 shadow-lg">
            <div id="logo-container">
                <div id="text-overlay">Tanim AI</div>
                <canvas id="logo-canvas" width="64" height="64" style="width: 2.5rem; height: 2.5rem;"></canvas>
            </div>
            <div class="flex items-center gap-2">
                <button id="summarize-btn" class="glass-btn rounded-md px-3 py-1 text-sm font-semibold" data-lang-key="summarize_btn"></button>
                <button id="lang-toggle-btn" class="glass-btn rounded-md px-3 py-1 text-sm font-semibold"></button>
            </div>
        </header>

        <main id="chat-container" class="flex-1 p-4 overflow-y-auto">
            <div class="flex justify-start mb-4">
                <div class="message-bubble ai text-white p-3 rounded-lg max-w-[85%] inline-block" data-lang-key="welcome_message"></div>
            </div>
        </main>

        <div id="image-preview-container" class="hidden p-2 px-4 glass-ui z-10">
             <div class="relative inline-block">
                <img id="image-preview" src="" class="h-20 w-20 object-cover rounded-md" style="border: 1px solid var(--accent-dark);">
                <button id="remove-image-btn" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full h-6 w-6 flex items-center justify-center text-xs font-bold">&times;</button>
            </div>
        </div>

        <footer class="p-4 glass-ui z-10">
            <form id="chat-form" class="flex items-center gap-3">
                <button type="button" id="gallery-btn" class="glass-btn p-2.5 rounded-full flex-shrink-0" title="Upload Image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                </button>
                <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                
                <div class="relative w-full flex items-center">
                    <input type="text" id="prompt-input" class="w-full pl-12 pr-4 py-2 bg-black/30 border rounded-full focus:outline-none focus:ring-2 text-white transition" style="border-color: var(--accent-dark); --tw-ring-color: var(--accent-color);" data-lang-key="placeholder">
                    <button type="button" id="search-toggle-btn" class="absolute left-3 glass-btn rounded-full p-1.5" title="Toggle Web Search">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                        </svg>
                    </button>
                </div>

                <button type="submit" id="send-btn" class="text-black font-bold p-2.5 rounded-full shadow-lg transform hover:scale-105 transition flex-shrink-0" style="background-color: var(--accent-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg>
                </button>
                <button type="button" id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold p-2.5 rounded-full shadow-lg transform hover:scale-105 transition hidden flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><rect width="16" height="16" fill="currentColor"/></svg>
                </button>
                <button type="button" id="mic-btn" class="glass-btn p-2.5 rounded-full flex-shrink-0" title="Voice Input">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                        <path d="M8 1a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    </svg>
                </button>
            </form>
        </footer>
    </div>
    
    <div id="summary-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="glass-ui rounded-lg p-6 max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold" style="color: var(--accent-color);" data-lang-key="summary_title"></h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="summary-content" class="overflow-y-auto text-gray-300"></div>
            <div id="summary-loading" class="hidden text-center p-4">
                <div class="loader-spinner mx-auto"></div>
                <p class="mt-2" data-lang-key="summarizing"></p>
            </div>
        </div>
    </div>

    <div id="update-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="glass-ui rounded-lg p-4 max-w-sm w-full text-center relative">
            <img src="https://file-stream-bot-bjom.onrender.com/dl/554?code=6c57de9e" alt="Update Poster" class="w-full h-auto rounded-md mb-4">
            <div class="flex items-center justify-center mb-4">
                <input type="checkbox" id="dont-show-again" class="w-4 h-4">
                <label for="dont-show-again" class="ml-2 text-sm text-gray-300">Don't show again</label>
            </div>
            <button id="close-update-modal-btn" class="w-full text-black font-bold py-2 px-4 rounded-full transition" style="background-color: var(--accent-color);">Close</button>
        </div>
    </div>


    <script>
        // --- WebGL Animation Script (Oporibortito) ---
        (function(){const vsSource=`attribute vec2 a_position;void main(){gl_Position=vec4(a_position,0.,1.);}`;const fsSource=`\n              precision mediump float;\n              uniform float t;\n              uniform vec2 r;\n              vec2 myTanh(vec2 x){vec2 ex=exp(x);vec2 emx=exp(-x);return(ex-emx)/(ex+emx);}\n              void main(){\n                  vec4 o_bg=vec4(0.);vec4 o_anim=vec4(0.);\n                  vec2 center_offset=vec2(r.x*.65,r.y*.5);\n                  {\n                      vec2 p_img=((gl_FragCoord.xy-center_offset)*2.)/r.y;\n                      p_img.xy=vec2(p_img.y,-p_img.x);p_img*=2.5;\n                      vec2 l_val=myTanh(p_img*5.+2.);l_val=min(l_val,l_val*3.);\n                      vec2 clamped=clamp(l_val,-2.,0.);float diff_y=clamped.y-l_val.y;\n                      float safe_px=abs(p_img.x)<.001?.001:p_img.x;\n                      float term=(.1-max(.01-dot(p_img,p_img)/200.,0.)*(diff_y/safe_px))/abs(length(p_img)-.7);\n                      o_bg+=vec4(term);o_bg*=max(o_bg,vec4(0.));\n                  }\n                  {\n                      vec2 p_base=((gl_FragCoord.xy-center_offset)*2.)/r.y;p_base*=2.5;\n                      vec2 p_anim=vec2(p_base.y,-p_base.x);float angle=-400.*3.14159/180.;\n                      float s=sin(angle);float c_rot=cos(angle);mat2 rotMat=mat2(c_rot,-s,s,c_rot);\n                      vec2 p_effect=rotMat*p_base;vec2 d=vec2(-1.,1.);\n                      float denom=.1+5./dot(5.*p_effect-d,5.*p_effect-d);\n                      vec2 c=p_effect*mat2(1.,1.,d.x/denom,d.y/denom);vec2 v=c;\n                      vec4 animAccum=vec4(0.);\n                      for(int i=1;i<=9;i++){\n                          float fi=float(i);\n                          animAccum+=sin(vec4(v.x,v.y,v.y,v.x))+vec4(1.);\n                          v+=.7*sin(vec2(v.y,v.x)*fi+t)/fi+.5;\n                      }\n                      vec4 animTerm=1.-exp(-exp(c.x*vec4(.6,-.4,-1.,0.))/animAccum/(.1+.1*pow(length(sin(v/.3)*.2+c*vec2(1.,2.))-1.,2.))/(1.+7.*exp(.3*c.y-dot(c,c)))/(.03+abs(length(p_anim)-.7))*.2);\n                      o_anim+=animTerm;\n                  }\n                  vec4 finalColor=mix(o_bg,o_anim,.5)*1.5;\n                  finalColor=clamp(finalColor,0.,1.);\n                  gl_FragColor=finalColor;\n              }`;function setupWebGL(a,e){const t=document.getElementById(a);if(!t)return;const n=t.getContext("webgl");if(!n)return console.error(`WebGL not supported for canvas: ${a}`),void(e||(document.body.style.backgroundColor="#1F1301",t.style.display="none"));let o=fsSource;e&&(o=fsSource.replace("vec2 center_offset = vec2(r.x * 0.65, r.y * 0.5);","vec2 center_offset = vec2(r.x * 0.5, r.y * 0.5);"));const i=createProgram(n,createShader(n,n.VERTEX_SHADER,vsSource),createShader(n,n.FRAGMENT_SHADER,o));if(!i)return;n.useProgram(i);const s=n.getAttribLocation(i,"a_position"),l=n.getUniformLocation(i,"t"),r=n.getUniformLocation(i,"r"),c=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),d=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,d),n.bufferData(n.ARRAY_BUFFER,c,n.STATIC_DRAW),n.enableVertexAttribArray(s),n.vertexAttribPointer(s,2,n.FLOAT,!1,0,0);function m(){t.width=window.innerWidth,t.height=window.innerHeight,n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight)}e?n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight):(window.addEventListener("resize",m),m());let p=performance.now();!function g(){let a=performance.now(),e=(a-p)/1e3;n.uniform1f(l,e),n.uniform2f(r,t.width,t.height),n.drawArrays(n.TRIANGLES,0,6),requestAnimationFrame(g)}()}function createShader(a,e,t){const n=a.createShader(e);return a.shaderSource(n,t),a.compileShader(n),a.getShaderParameter(n,a.COMPILE_STATUS)?n:(console.error("Shader compile error: "+a.getShaderInfoLog(n)),a.deleteShader(n),null)}function createProgram(a,e,t){if(!e||!t)return null;const n=a.createProgram();return a.attachShader(n,e),a.attachShader(n,t),a.linkProgram(n),a.getProgramParameter(n,a.LINK_STATUS)?n:(console.error("Program link error: "+a.getProgramInfoLog(n)),a.deleteProgram(n),null)}setupWebGL("glcanvas",!1),setupWebGL("logo-canvas",!0)})();

        // --- Chat Application Script (Poribortito and Shurokkhito) ---
        const langToggleBtn=document.getElementById("lang-toggle-btn"),chatContainer=document.getElementById("chat-container"),chatForm=document.getElementById("chat-form"),promptInput=document.getElementById("prompt-input"),sendBtn=document.getElementById("send-btn"),stopBtn=document.getElementById("stop-btn"),micBtn=document.getElementById("mic-btn"),galleryBtn=document.getElementById("gallery-btn"),imageUploadInput=document.getElementById("image-upload-input"),imagePreviewContainer=document.getElementById("image-preview-container"),imagePreview=document.getElementById("image-preview"),removeImageBtn=document.getElementById("remove-image-btn"),summarizeBtn=document.getElementById("summarize-btn"),summaryModal=document.getElementById("summary-modal"),closeModalBtn=document.getElementById("close-modal-btn"),summaryContent=document.getElementById("summary-content"),summaryLoading=document.getElementById("summary-loading"),searchToggleBtn=document.getElementById("search-toggle-btn"),updateModal=document.getElementById("update-modal"),closeUpdateModalBtn=document.getElementById("close-update-modal-btn"),dontShowAgainCheckbox=document.getElementById("dont-show-again");let currentLang="bn",isSearchEnabled=!1,uploadedImageBase64=null,currentAudio=null,currentPlayingBtn=null,abortController=null;const systemInstruction={role:"system",parts:[{text:"You are Tanim AI, a helpful AI assistant. Your primary language is Bengali (Bangla). Your secondary language is English. Use 'Assalamualaikum' only for the very first greeting if appropriate, but do not repeat it in every subsequent response. Never use 'Nomoskar'. When answering questions about math, physics, or chemistry, ALWAYS format equations and formulas using LaTeX code. For formulas that are part of a sentence, use single dollar signs (e.g., the formula is $E=mc^2$). For standalone equations that need their own line, use double dollar signs (e.g., $$x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$$). Ensure text flows naturally around inline formulas without unnecessary line breaks. Write your answers in a well-organized, eloquent, and beautiful style. Be thorough and clear."}]};let chatHistory=[];const translations={en:{welcome_message:"Assalamualaikum, I am Tanim AI. How can I help you?",placeholder:"Type your message...",lang_btn:"বাংলা",summarize_btn:"✨ Summarize",summary_title:"Conversation Summary",summarizing:"Summarizing...",error_message:"Sorry, an error occurred. Please try again."},bn:{welcome_message:"আসসালামু আলাইকুম, আমি তানিম এআই। আমি আপনাকে কিভাবে সাহায্য করতে পারি?",placeholder:"আপনার বার্তা লিখুন...",lang_btn:"English",summarize_btn:"✨ সারসংক্ষেপ",summary_title:"কথোপকথনের সারসংক্ষেপ",summarizing:"সারসংক্ষেপ করা হচ্ছে...",error_message:"দুঃখিত, একটি ত্রুটি ঘটেছে। অনুগ্রহ করে আবার চেষ্টা করুন।"}};const setLanguage=a=>{currentLang=a,document.querySelectorAll("[data-lang-key]").forEach(e=>{const t=e.getAttribute("data-lang-key");translations[a][t]&&("INPUT"===e.tagName?e.placeholder=translations[a][t]:e.innerHTML=translations[a][t])}),langToggleBtn.textContent=translations[a].lang_btn};const addMessageToUI=(a,e,t=null)=>{const n=document.createElement("div");n.className=`flex mb-4 ${"user"===e?"justify-end":"justify-start"}`;const o=document.createElement("div");if(o.className=`message-bubble ${e} p-3 rounded-lg max-w-[85%] inline-block`,t){const a=document.createElement("img");a.src=t,a.className="rounded-md mb-2 max-w-full h-auto",o.appendChild(a)}if(a){const e=document.createElement("div");e.innerHTML=a.replace(/\n/g,"<br>"),o.appendChild(e)}if("ai"===e&&a){const e=document.createElement("button");e.className="tts-btn ml-2 align-middle inline-block",e.innerHTML='<svg class="speaker-icon-off" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707z"/><path d="M10.121 12.596A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706z"/><path d="M8.707 11.182A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.063-1.89a.5.5 0 0 1 .829-.06z"/></svg><svg class="speaker-icon-on" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.536 14.01A8.473 8.473 0 0 0 14.026 8a8.473 8.473 0 0 0-2.49-6.01l-.708.707A7.476 7.476 0 0 1 13.025 8c0 2.071-.84 3.946-2.197 5.303l.708.707zm-1.414-.707A6.48 6.48 0 0 0 12.025 8a6.48 6.48 0 0 0-1.904-4.596l-.707.707A5.483 5.483 0 0 1 11.025 8a5.483 5.483 0 0 1-1.61 3.89l.706.706zm-1.414-.707A4.486 4.486 0 0 0 10.025 8a4.486 4.486 0 0 0-1.318-3.182L8 5.525A3.489 3.489 0 0 1 9.025 8 3.49 3.49 0 0 1 8 10.475l.707.707zM6.717 3.55A.5.5 0 0 1 7 4v8a.5.5 0 0 1-.812.39L3.825 10.5H1.5A.5.5 0 0 1 1 10V6a.5.5 0 0 1 .5-.5h2.325l2.063-1.89a.5.5 0 0 1 .829-.06z"/></svg>',e.onclick=()=>handleTTS(a,e),o.appendChild(e)}n.appendChild(o),chatContainer.appendChild(n),"ai"===e&&window.MathJax&&MathJax.typesetPromise([o]),chatContainer.scrollTop=chatContainer.scrollHeight};const showLoadingIndicator=()=>{const a=document.createElement("div");a.id="ai-loader",a.className="flex justify-start mb-4",a.innerHTML='<div class="message-bubble ai p-3 rounded-lg"><div class="loader-spinner"></div></div>',chatContainer.appendChild(a),chatContainer.scrollTop=chatContainer.scrollHeight},hideLoadingIndicator=()=>{const a=document.getElementById("ai-loader");a&&a.remove()},toggleSendStopButtons=a=>{sendBtn.classList.toggle("hidden",a),stopBtn.classList.toggle("hidden",!a)};
        
        // --- API CALL FUNCTION (Corrected to use Netlify backend) ---
        async function callUnifiedAPI(action, payload) {
            abortController = new AbortController();
            const signal = abortController.signal;

            try {
                // Calling your Netlify serverless function at /api/gemini
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Sending action and payload as expected by your backend function
                    body: JSON.stringify({ action: action, payload: payload }),
                    signal
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Server Function Error:", errorData);
                    throw new Error(errorData.error || `Server Function Error: ${response.status}`);
                }
                
                return await response.json();

            } catch (error) {
                if (error.name === 'AbortError') { 
                    console.log('Fetch aborted by user.');
                    return null;
                }
                console.error("API Call Error:", error);
                throw error;
            }
        }

        const handleChatSubmit = async (e) => {
            e.preventDefault();
            const userPrompt = promptInput.value.trim();
            if (!userPrompt && !uploadedImageBase64) return;
            const imageSrcForUI = uploadedImageBase64 ? `data:image/png;base64,${uploadedImageBase64}` : null;
            addMessageToUI(userPrompt, "user", imageSrcForUI);
            const userParts = [{ text: userPrompt }];
            if (uploadedImageBase64) {
                userParts.push({ inlineData: { mimeType: "image/png", data: uploadedImageBase64 } });
            }
            const userMessage = { role: "user", parts: userParts };
            promptInput.value = '';
            clearImagePreview();
            promptInput.disabled = true;
            toggleSendStopButtons(true);
            showLoadingIndicator();
            try {
                const payload = { contents: [...chatHistory, userMessage], systemInstruction };
                if (isSearchEnabled) {
                    payload.tools = [{ "google_search": {} }];
                }
                const result = await callUnifiedAPI('chat', payload);
                if (result) {
                    const finalResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || translations[currentLang].error_message;
                    hideLoadingIndicator();
                    addMessageToUI(finalResponse, 'ai');
                    chatHistory.push(userMessage, { role: "model", parts: [{ text: finalResponse }] });
                } else {
                    hideLoadingIndicator(); // Handle abortion case
                }
            } catch (error) {
                hideLoadingIndicator();
                addMessageToUI(`${translations[currentLang].error_message}`, 'ai');
            } finally {
                promptInput.disabled = false;
                toggleSendStopButtons(false);
                abortController = null;
                promptInput.focus();
            }
        };

        const handleSummarize = async () => {
            summaryModal.classList.remove("hidden");
            summaryContent.classList.add("hidden");
            summaryLoading.classList.remove("hidden");
            const conversation = chatHistory.map(item => `${item.role}: ${item.parts.map(p => p.text).join(" ")}`).join("\n");
            const summaryPrompt = `Please provide a concise summary in ${currentLang === 'bn' ? 'Bengali' : 'English'} of the following conversation:\n\n${conversation}`;
            const payload = { contents: [{ role: 'user', parts: [{ text: summaryPrompt }] }], systemInstruction };
            try {
                const result = await callUnifiedAPI('summarize', payload);
                const summary = result?.candidates?.[0]?.content?.parts?.[0]?.text || translations[currentLang].error_message;
                summaryContent.innerHTML = summary.replace(/\n/g, "<br>");
            } catch (error) {
                console.error("Summarize Error:", error);
                summaryContent.textContent = translations[currentLang].error_message;
            } finally {
                summaryLoading.classList.add("hidden");
                summaryContent.classList.remove("hidden");
            }
        };

        const handleTTS = async (text, btn) => {
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                if (currentPlayingBtn) currentPlayingBtn.classList.remove('playing');
                if (currentPlayingBtn === btn) {
                    currentPlayingBtn = null;
                    currentAudio = null;
                    return;
                }
            }
            btn.classList.add('playing');
            currentPlayingBtn = btn;
            try {
                const payload = {
                    contents: [{ parts: [{ text: `Say in a natural and clear voice: ${text}` }] }],
                    generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
                };
                const result = await callUnifiedAPI('tts', payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType?.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    currentAudio = new Audio(audioUrl);
                    currentAudio.onended = () => {
                        btn.classList.remove('playing');
                        currentPlayingBtn = null;
                        currentAudio = null;
                    };
                    currentAudio.play();
                } else {
                    throw new Error("Invalid audio data received.");
                }
            } catch (error) {
                console.error("TTS Error:", error);
                btn.classList.remove('playing');
                currentPlayingBtn = null;
            }
        };
        
        // Baki shob helper functions oporibortito
        const base64ToArrayBuffer=a=>{const e=atob(a),t=e.length,n=new Uint8Array(t);for(let a=0;a<t;a++)n[a]=e.charCodeAt(a);return n.buffer},writeString=(a,e,t)=>{for(let n=0;n<t.length;n++)a.setUint8(e+n,t.charCodeAt(n))},pcmToWav=(a,e)=>{const t=new ArrayBuffer(44+a.byteLength),n=new DataView(t);writeString(n,0,"RIFF"),n.setUint32(4,36+a.byteLength,!0),writeString(n,8,"WAVE"),writeString(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,e,!0),n.setUint32(28,2*e,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),writeString(n,36,"data"),n.setUint32(40,a.byteLength,!0);const o=new Uint8Array(a.buffer,a.byteOffset,a.byteLength);return new Uint8Array(n.buffer,44).set(o),new Blob([n],{type:"audio/wav"})};const handleImageUpload=a=>{const e=a.target.files[0];if(!e)return;const t=new FileReader;t.onload=a=>{uploadedImageBase64=a.target.result.split(",")[1],imagePreview.src=a.target.result,imagePreviewContainer.classList.remove("hidden")},t.readAsDataURL(e)},clearImagePreview=()=>{uploadedImageBase64=null,imagePreview.src="",imagePreviewContainer.classList.add("hidden"),imageUploadInput.value=""};const handleMicInput=()=>{const a=window.SpeechRecognition||window.webkitSpeechRecognition;if(!a)return alert("Sorry, speech recognition is not supported in this browser.");const e=new a;e.lang="bn"===currentLang?"bn-BD":"en-US",e.interimResults=!1,e.maxAlternatives=1,micBtn.classList.add("listening"),e.start(),e.onresult=a=>{promptInput.value=a.results[0][0].transcript},e.onspeechend=()=>{e.stop(),micBtn.classList.remove("listening")},e.onerror=a=>{console.error("Speech recognition error:",a.error),micBtn.classList.remove("listening")}};const setAppHeight=()=>{document.getElementById("app-container").style.height=`${window.innerHeight}px`};const handleSearchToggle=()=>{isSearchEnabled=!isSearchEnabled,searchToggleBtn.classList.toggle("search-active",isSearchEnabled)};langToggleBtn.addEventListener("click",()=>setLanguage("en"===currentLang?"bn":"en")),chatForm.addEventListener("submit",handleChatSubmit),galleryBtn.addEventListener("click",()=>imageUploadInput.click()),imageUploadInput.addEventListener("change",handleImageUpload),removeImageBtn.addEventListener("click",clearImagePreview),summarizeBtn.addEventListener("click",handleSummarize),closeModalBtn.addEventListener("click",()=>summaryModal.classList.add("hidden")),stopBtn.addEventListener("click",()=>abortController?.abort()),micBtn.addEventListener("click",handleMicInput),searchToggleBtn.addEventListener("click",handleSearchToggle),closeUpdateModalBtn.addEventListener("click",()=>{dontShowAgainCheckbox.checked&&localStorage.setItem("hideUpdateModal","true"),updateModal.classList.add("hidden")}),window.addEventListener("resize",setAppHeight),setLanguage("bn"),setAppHeight(),document.querySelector('[data-lang-key="welcome_message"]').textContent=translations.bn.welcome_message;const hideModal=localStorage.getItem("hideUpdateModal");"true"!==hideModal&&updateModal.classList.remove("hidden");

    </script>
</body>
</html>

